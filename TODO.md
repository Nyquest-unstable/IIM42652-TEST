# IIM42652 振动唤醒(WOM)功能实现计划

## 项目概述
为IIM42652传感器项目添加振动唤醒(Wake on Motion)功能，并实现不同工作模式之间的切换。

## 任务清单

### 1. 项目分析与理解
- [x] 分析现有项目结构和代码
- [x] 理解传感器驱动初始化过程
- [x] 查找WOM相关的API函数
- [x] 确认项目使用的芯片型号为IIM42652

### 2. WOM功能实现
- [ ] 添加WOM阈值配置函数
- [ ] 实现振动唤醒使能函数
- [ ] 添加回调函数处理WOM中断事件
- [ ] 实现WOM模式下的低功耗配置

#### 2.1 WOM配置函数
- [ ] 使用`inv_ixm42xxx_configure_smd_wom()`设置X、Y、Z轴的阈值
- [ ] 参数包括三个轴向的阈值以及中断模式和比较模式
- [ ] 合理设置阈值以检测所需的振动强度

#### 2.2 WOM使能函数
- [ ] 使用`inv_ixm42xxx_enable_wom()`启用振动唤醒功能
- [ ] 配置传感器进入低功耗模式
- [ ] 确保中断引脚正确配置以响应唤醒事件

### 3. 模式切换功能
- [ ] 实现普通测量模式和WOM模式之间的切换
- [ ] 添加SMD（显著运动检测）模式选项
- [ ] 提供用户接口用于触发模式切换

#### 3.1 模式定义
- [ ] 普通模式：连续测量加速度计和陀螺仪数据
- [ ] WOM模式：低功耗模式，仅在检测到运动时唤醒
- [ ] SMD模式：检测显著运动事件

#### 3.2 切换机制
- [ ] 实现模式切换函数
- [ ] 在WOM模式下配置合适的ODR（输出数据率）
- [ ] 确保模式切换过程中传感器状态的一致性

### 4. 主程序修改
- [ ] 在main.c中添加WOM配置代码段
- [ ] 修改传感器初始化流程以支持WOM
- [ ] 添加模式切换的控制逻辑

#### 4.1 初始化流程更新
```c
// 在传感器初始化后添加:
// 1. 设置WOM阈值
rc = inv_ixm42xxx_configure_smd_wom(&sensor_driver, 
                                    IXM42XXX_DEFAULT_WOM_THS_MG, 
                                    IXM42XXX_DEFAULT_WOM_THS_MG, 
                                    IXM42XXX_DEFAULT_WOM_THS_MG,
                                    IXM42XXX_SMD_CONFIG_WOM_INT_MODE_ORED, 
                                    IXM42XXX_SMD_CONFIG_WOM_MODE_CMP_PREV);

// 2. 启用WOM功能
rc |= inv_ixm42xxx_enable_wom(&sensor_driver);
```

#### 4.2 数据处理循环调整
- [ ] 根据当前模式调整数据采集方式
- [ ] 在WOM模式下优化数据读取策略

### 5. 中断处理优化
- [ ] 修改handle_fifo_data回调函数，使其能够处理WOM中断事件
- [ ] 当WOM被触发时，执行相应的唤醒处理逻辑
- [ ] 可选择在WOM触发后切换到活动模式进行详细数据采集

### 6. 平台抽象层适配
- [ ] 确保平台抽象函数(延时、时间戳、中断控制、SPI/I2C读写)正确实现
- [ ] 验证微秒级延时函数的精度
- [ ] 确认SPI通信函数正常工作

### 7. 测试验证
- [ ] 编译并构建项目，确保无错误
- [ ] 在实际硬件上测试WOM功能
- [ ] 验证模式切换是否按预期工作
- [ ] 测量低功耗模式下的功耗降低效果
- [ ] 测试不同阈值设置对唤醒灵敏度的影响

### 8. 文档完善
- [ ] 更新README.md说明WOM功能的使用方法
- [ ] 记录不同阈值设置的最佳实践
- [ ] 添加故障排除指南

## 注意事项
1. 在桌面环境下编译通过不代表硬件初始化成功，重点关注代码框架的正确性
2. WOM功能需要在传感器处于低功耗模式时才能发挥最佳效果
3. 阈值设置需要根据实际应用场景进行调整，过高可能无法检测到有效运动，过低可能导致频繁误唤醒
4. 模式切换时需要正确处理传感器的状态转换，避免出现不稳定的情况